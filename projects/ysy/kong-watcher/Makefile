# Kong Gateway eBPF Monitor Makefile

# ë³€ìˆ˜ ì„¤ì •
IMG ?= harbor.ops.action.cloudz.co.kr/apim/kong-watcher:0.0.1
PODMAN_BUILD_ARGS ?= --tls-verify=false

.PHONY: all build clean generate test podman-build podman-push podman-buildx run k8s-deploy k8s-delete k8s-status k8s-logs

# ê¸°ë³¸ íƒ€ê²Ÿ
all: generate build

# eBPF ì½”ë“œ ìƒì„± (amd64ë§Œ)
generate:
	@echo "eBPF ì½”ë“œ ìƒì„± ì¤‘..."
	GOOS=linux GOARCH=amd64 go generate

# Go ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
build: generate
	@echo "Go ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ì¤‘..."
	@echo "ë¶ˆí•„ìš”í•œ ì•„í‚¤í…ì²˜ íŒŒì¼ ì œê±° ì¤‘..."
	rm -f bpf_bpfeb.go kprobe_bpfeb.go uprobe_bpfeb.go
	go build -o kong-watcher *.go


# í…ŒìŠ¤íŠ¸ ì‹¤í–‰
test:
	@echo "í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	go test -v ./...

# ì •ë¦¬
clean:
	@echo "ë¹Œë“œ íŒŒì¼ ì •ë¦¬ ì¤‘..."
	rm -f kong-watcher
	rm -f bpf_*.go
	rm -f bpf_*.o
	rm -f kprobe_*.go
	rm -f kprobe_*.o
	rm -f uprobe_*.go
	rm -f uprobe_*.o

# Podman ì´ë¯¸ì§€ ë¹Œë“œ (amd64 ì „ìš©)
podman-build: ## Build podman image for amd64
	@echo "ğŸ—ï¸  Building podman image for amd64..."
	podman build $(PODMAN_BUILD_ARGS) --platform linux/amd64 --build-arg TARGETOS=linux --build-arg TARGETARCH=amd64 --tag ${IMG} -f Dockerfile .
	@echo "âœ… Podman build completed successfully"

# Podman ì´ë¯¸ì§€ í‘¸ì‹œ
podman-push: ## Push podman image
	@echo "ğŸ“¤ Pushing podman image..."
	podman push --tls-verify=false --retry=3 --retry-delay=5s --compression-format=gzip --compression-level=6 ${IMG}
	@echo "âœ… Podman push completed successfully"

# Podman ë¹Œë“œ ë° í‘¸ì‹œ (amd64 ì „ìš©)
podman-buildx: podman-build podman-push ## Build and push podman image for amd64
	@echo "âœ… amd64 build and push completed successfully"

# ë¡œì»¬ ì‹¤í–‰ (ê°œë°œìš©)
run: build
	@echo "ë¡œì»¬ì—ì„œ ì‹¤í–‰ ì¤‘..."
	sudo ./kong-watcher

# ì˜ì¡´ì„± ì„¤ì¹˜
deps:
	@echo "ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
	go mod tidy
	go get github.com/cilium/ebpf
	go get github.com/cilium/ebpf/cmd/bpf2go

# ê°œë°œ í™˜ê²½ ì„¤ì •
dev-setup: deps
	@echo "ê°œë°œ í™˜ê²½ ì„¤ì • ì¤‘..."
	@echo "í•„ìš”í•œ ë„êµ¬ë“¤:"
	@echo "- clang (eBPF ì»´íŒŒì¼ìš©)"
	@echo "- llvm (eBPF ì»´íŒŒì¼ìš©)"
	@echo "- bpftool (eBPF ë””ë²„ê¹…ìš©)"
	@echo "- podman (ì»¨í…Œì´ë„ˆ ë¹Œë“œìš©)"
	@echo ""
	@echo "Ubuntu/Debian:"
	@echo "sudo apt-get install clang llvm bpftool podman"
	@echo ""
	@echo "CentOS/RHEL:"
	@echo "sudo yum install clang llvm bpftool podman"
	@echo ""
	@echo "macOS:"
	@echo "brew install llvm podman"

# Kubernetes ë°°í¬
k8s-deploy: ## Kubernetesì— ë°°í¬
	@echo "ğŸš€ Kubernetesì— ë°°í¬ ì¤‘..."
	kubectl apply -f deployment.yaml
	@echo "âœ… ë°°í¬ ì™„ë£Œ"

k8s-delete: ## Kubernetesì—ì„œ ì‚­ì œ
	@echo "ğŸ—‘ï¸  Kubernetesì—ì„œ ì‚­ì œ ì¤‘..."
	kubectl delete -f deployment.yaml
	@echo "âœ… ì‚­ì œ ì™„ë£Œ"

k8s-status: ## Kubernetes ë°°í¬ ìƒíƒœ í™•ì¸
	@echo "ğŸ“Š ë°°í¬ ìƒíƒœ í™•ì¸ ì¤‘..."
	kubectl get pods -n default
	kubectl get deployment -n default
	kubectl get service -n default

k8s-logs: ## Kubernetes Pod ë¡œê·¸ í™•ì¸
	@echo "ğŸ“‹ Pod ë¡œê·¸ í™•ì¸ ì¤‘..."
	kubectl logs -f deployment/kong-watcher -n default

# ë„ì›€ë§
help:
	@echo "ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:"
	@echo "  make all              - eBPF ì½”ë“œ ìƒì„± ë° ë¹Œë“œ"
	@echo "  make generate         - eBPF ì½”ë“œ ìƒì„±"
	@echo "  make build            - Go ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ"
	@echo "  make test             - í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
	@echo "  make clean            - ë¹Œë“œ íŒŒì¼ ì •ë¦¬"
	@echo "  make podman-build     - Podman ì´ë¯¸ì§€ ë¹Œë“œ"
	@echo "  make podman-push      - Podman ì´ë¯¸ì§€ í‘¸ì‹œ"
	@echo "  make podman-buildx    - Podman amd64 ë¹Œë“œ ë° í‘¸ì‹œ"
	@echo "  make run              - ë¡œì»¬ì—ì„œ ì‹¤í–‰"
	@echo "  make deps             - ì˜ì¡´ì„± ì„¤ì¹˜"
	@echo "  make dev-setup        - ê°œë°œ í™˜ê²½ ì„¤ì •"
	@echo "  make k8s-deploy       - Kubernetesì— ë°°í¬"
	@echo "  make k8s-delete       - Kubernetesì—ì„œ ì‚­ì œ"
	@echo "  make k8s-status       - Kubernetes ë°°í¬ ìƒíƒœ í™•ì¸"
	@echo "  make k8s-logs         - Kubernetes Pod ë¡œê·¸ í™•ì¸"
	@echo "  make help             - ì´ ë„ì›€ë§ í‘œì‹œ"
	@echo ""
	@echo "í™˜ê²½ ë³€ìˆ˜:"
	@echo "  IMG                   - ì´ë¯¸ì§€ ì´ë¦„:íƒœê·¸ (ê¸°ë³¸ê°’: harbor.ops.action.cloudz.co.kr/apim/kong-watcher:0.0.1)"
	@echo "  PODMAN_BUILD_ARGS     - Podman ë¹Œë“œ ì¸ìˆ˜ (ê¸°ë³¸ê°’: --tls-verify=false)"
