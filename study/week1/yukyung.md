### 환경 설정

```
sudo bpftrace -e 'tracepoint:raw_syscalls:sys_enter { @[comm] = count(); }'
```

<img width="1225" height="272" alt="스크린샷 2025-09-15 오후 9 33 28" src="https://github.com/user-attachments/assets/9e3e0c05-ad89-4773-95d3-9f9f070f7728" />

<br>

### eBPF란? 

<img width="1508" height="777" alt="image" src="https://github.com/user-attachments/assets/7ad037c0-65bd-4e2b-9d2e-2b3f35e5e2dc" />

eBPF(Extended Berkeley Packet Filter)는 리눅스 커널의 기능을 안전하고 유연하게 확장할 수 있도록 설계된 기술입니다. 

커널을 직접 수정하거나 별도의 커널 모듈을 삽입하지 않아도, 격리된 환경에서 실행되는 작은 프로그램을 통해 트레이싱, 네트워크 제어, 보안 감시, 성능 분석 등 다양한 기능을 커널에 동적으로 추가할 수 있습니다.

<br>

### eBPF 특징

- 커널 코드를 수정하지 않고도 동적으로 동작을 바꿀 수 있어, 새로운 기능을 빠르게 실험할 수 있음
- Verifier를 통해 프로그램의 안전성을 미리 검사해, 커널에 악영향을 주지 않도록 설계됨
- 작성한 eBPF 코드는 바이트코드로 변환된 뒤 실시간으로 컴파일되어, 실행 성능이 뛰어남
- eBPF 맵을 통해 프로그램 간에 데이터를 저장하거나 주고받을 수 있음
- 일부 커널 API(헬퍼 함수)만 사용할 수 있어, 커널 전체의 안정성과 호환성을 유지할 수 있음
- 다른 eBPF 프로그램을 호출해 복잡한 작업 흐름도 구성 가능함

<br>

### 동작 과정

**1. 프로그램 작성** <br>
C와 유사한 문법으로 eBPF 프로그램을 작성하고, Clang/LLVM을 사용해 바이트코드로 컴파일

**2. 커널에 로드** <br>
bpf() 시스템 콜을 통해 커널에 로드하며, 일반적으로 root 권한 또는 CAP_BPF 권한이 필요

**3. 검증 단계** <br>
Verifier가 프로그램을 분석해 무한 루프, 잘못된 메모리 접근 등 위험 요소가 없는지 확인

**4. JIT 컴파일** <br>
바이트코드는 커널에서 네이티브 명령어로 변환되어 성능을 최적화한 상태로 실행됨

**5. 이벤트 발생 시 실행** <br>
시스템 콜, 네트워크 트래픽, tracepoint 등 커널 이벤트가 발생하면 해당 eBPF 프로그램이 트리거되어 실행

<br>

### 훅

<img width="1177" height="895" alt="image" src="https://github.com/user-attachments/assets/b6cdb061-81ea-466f-b8ee-656f27119950" />

eBPF 프로그램은 **이벤트 기반**으로 동작합니다. 즉, 커널 또는 사용자 애플리케이션이 **특정 지점**을 지나갈 때, 해당 위치에 연결된 eBPF 프로그램이 자동으로 실행됩니다.
이러한 훅은 bpf() 시스템 콜을 통해 커널에 프로그램을 로드함으로써 연결됩니다. 보통은 libbpf, bpftrace, bcc와 같은 eBPF 유틸리티 라이브러리를 활용해 로딩 및 연결을 간편하게 처리합니다.

<br>

### 맵

eBPF에서는 맵을 통해 프로그램 간 데이터를 저장하거나 공유할 수 있습니다. eBPF 프로그램은 맵에 값을 기록하거나 조회할 수 있으며, 유저 공간 애플리케이션도 bpf_map_* 인터페이스를 통해 동일한 맵에 접근할 수 있습니다.

<br>

### 헬퍼 함수 호출

eBPF 프로그램은 일반적인 커널 함수를 직접 호출할 수 없습니다. 커널 함수는 버전에 따라 내부 구조나 동작 방식이 달라질 수 있기 때문에, 자유로운 호출을 허용하면 버전 호환성과 안정성에 문제가 생길 수 있습니다.
이를 대신해, 커널은 안전성이 검증된 헬퍼 함수를 제공합니다.

<br>

### 참고 링크
[🔗 공식 문서](https://ebpf.io/ko-kr/what-is-ebpf/#ebpf-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%A8%EC%9D%80-%EC%96%B4%EB%96%BB%EA%B2%8C-%EC%9E%91%EC%84%B1%EB%90%98%EB%82%98%EC%9A%94)

<br>

### 진행하고자 하는 프로젝트

**🐝 eBPF-route**

> eBPF 기반 사용자 정의 라우터 구현

**프로젝트 목표**

- eBPF XDP + TC 기능을 활용해, 커널 라우팅 테이블 없이도 패킷을 Drop/Forward/Redirect
- 유저 공간에서 라우팅 테이블을 정의하고 동적으로 제어
- 목적지 IP에 따라 패킷을 특정 NIC 또는 CPU로 직접 포워딩
  
